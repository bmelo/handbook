
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preprocessing with fMRIprep &#8212; The Princeton Handbook for Reproducible Neuroimaging</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="canonical" href="https://brainhack-princeton.github.io/handbook//content_pages/03-04-fmriprep.html" />
    <link rel="shortcut icon" href="../_static/tigerBrain_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Understanding your fMRIprep outputs" href="03-05-fmriprepOutputs.html" />
    <link rel="prev" title="Quality control with MRIQC" href="03-03-mriqc.html" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    div.body {
      min-width: initial;
      max-width: initial;
    }
  </style>

  
  <link rel="canonical" href="https://handbook.datalad.org/content_pages/03-04-fmriprep/"/>
  <meta property="og:url" content="https://handbook.datalad.org/content_pages/03-04-fmriprep">
  

  <link rel="icon" type="image/png" href="https://media.readthedocs.org/images/favicon.png">

  <meta name="twitter:card" content="summary">
  <meta property="twitter:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:title" content="Preprocessing with fMRIprep &#8212; The Princeton Handbook for Reproducible Neuroimaging">
  <meta property="og:type" content="article">
  
  <meta property="og:description" content="">


  </head><body>
  <script type="text/javascript">

  $(window).scroll(function () {
    var s = $(window).scrollTop(),
          d = $(document).height(),
          c = $(window).height();
          scrollPercent = (s / (d-c)) * 100;
          var position = scrollPercent;

     $("#progressbar").attr('value', position);
  });
  </script>

  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="../index.html">
    <img class="logo" width="500" src="../_static/tigerBrain.png" title="The Princeton Handbook on Reproducible Neuroimaging"/>
  </a>
</p>

<!-- <p style="margin-left:auto; margin-right: auto;"><iframe src="https://ghbtns.com/github-btn.html?repo=book&user=datalad-handbook&type=star&count=true&size=large" allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe></p> -->

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> -->
<style>
.algolia-autocomplete{
  width: 100%;
  height: 1.5em
}
.algolia-autocomplete a{
  border-bottom: none !important;
}
#doc_search{
  width: 100%;
  height: 100%;
}
</style>

<progress id="progressbar" value="0" max="100"></progress>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Preprocessing with fMRIprep</a><ul>
<li><a class="reference internal" href="#running-fmriprep">Running fMRIPrep</a><ul>
<li><a class="reference internal" href="#before-running-for-the-first-time"><em>Before running for the first time</em></a></li>
<li><a class="reference internal" href="#submit-your-fmriprep-job"><em>Submit your fMRIPrep job</em></a></li>
</ul>
</li>
<li><a class="reference internal" href="#fmriprep-report">fMRIPrep Report</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="03-03-mriqc.html" title="previous chapter">Quality control with MRIQC</a></li>
      <li>Next: <a href="03-05-fmriprepOutputs.html" title="next chapter">Understanding your fMRIprep outputs</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><!-- Alabaster (krTheme++) Hacks -->
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            <div style="display:block;position:relative; margin-bottom: 1em;">
              <div style="display:block;width:100%;padding-top:12.5%;"></div>
              <div class="rpad" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
            </div>
            
  <div class="section" id="preprocessing-with-fmriprep">
<span id="fmriprep"></span><h1>Preprocessing with fMRIprep<a class="headerlink" href="#preprocessing-with-fmriprep" title="Permalink to this headline">¶</a></h1>
<style> .blue {color:blue} </style>
<style> .red {color:red} </style><p>Once you’ve converted your fMRI data to BIDS, you can begin preprocessing the data using fMRIPrep (<a class="reference external" href="https://doi.org/10.1101/306951">Esteban et al 2019</a>). FMRIprep is a BIDS App—a tool specifically designed to capitalize on the standardized format and rich metadata of BIDS.</p>
<p>Each version of fMRIPrep is released as a <a class="reference external" href="https://www.docker.com/">Docker</a> container (an encapsulated software environment containing all dependencies). For most purposes, we recommend running fMRIPrep on your institution’s server (instead of locally). To run fMRIPrep on a server without administrative privileges, we use <a class="reference external" href="https://www.sylabs.io/docs/">Singularity</a> (<a class="reference external" href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0177459">Kurtzer et al 2017</a>) instead of Docker. Singularity must be installed on the server to build and run Singularity images such as fMRIPrep. The fMRIPrep Docker image can be converted to a Singularity image for use on the server by running Singularity’s build command on Poldrack Lab’s fMRIPrep Docker image on Docker Hub:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ singularity build fmriprep-v20.2.0.simg docker://poldracklab/fmriprep:20.2.0
</pre></div>
</div>
<p>NOTE: At Princeton, Singularity images have been made for us! The sample scripts use Singularity images that already exist, so you do NOT need to build your own fMRIPrep Singularity image.</p>
<p>Running fMRIPrep on a single subject may take several hours. To run the fMRIPrep on the server, we recommend using your institution’s job scheduler (at Princeton, we use <a class="reference external" href="https://slurm.schedmd.com/">Slurm</a>).</p>
<div class="section" id="running-fmriprep">
<h2>Running fMRIPrep<a class="headerlink" href="#running-fmriprep" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">slurm_fmriprep.sh</span></code> script (which you can find in the <span class="blue">code/preprocessing/</span> directory) will run fMRIPrep on the cluster using the Slurm scheduler. It first runs fMRIprep for an individual subject, and then defaces the preprocessed “template” T1w image that is output by fMRIPrep.</p>
<p>This script will use the following two scripts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">run_fmriprep.sh</span></code> (this runs fMRIPrep)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deface_template.sh</span></code> (this defaces the template T1w)</p></li>
</ul>
<div class="section" id="before-running-for-the-first-time">
<h3><em>Before running for the first time</em><a class="headerlink" href="#before-running-for-the-first-time" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Customize your fMRIprep command line argument by understanding all the different options in the <a class="reference external" href="https://fmriprep.readthedocs.io/en/stable/usage.html">fMRIPrep documentation</a>!</p></li>
<li><p>Open <code class="docutils literal notranslate"><span class="pre">slurm_fmriprep.sh</span></code> and update the array number to list the subjects you want to run through fMRIPrep. You can run multiple subjects in parallel by using arrays (e.g., #SBATCH –array=001,002,003,004).</p></li>
<li><p>Update the #SBATCH –mail-user line to include your email address if you want to get email alerts when the job begins, ends, or fails.</p></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Remember, in Slurm scripts, lines that start with <code class="docutils literal notranslate"><span class="pre">#SBATCH</span></code> are Slurm commands, not comments! All other lines that start with <code class="docutils literal notranslate"><span class="pre">#</span></code> are regular comments.</p>
</div>
</div>
<div class="section" id="submit-your-fmriprep-job">
<h3><em>Submit your fMRIPrep job</em><a class="headerlink" href="#submit-your-fmriprep-job" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Make sure you are in the directory where the slurm script lives (<span class="blue">code/preprocessing/</span>). Then use sbatch command to submit the job.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># make sure you are in the code/preprocessing directory</span>
<span class="nb">cd</span> /jukebox/YOURLAB/USERNAME/YOURSTUDY/code/preprocessing/

<span class="c1"># submit the job</span>
sbatch slurm_fmriprep.sh
</pre></div>
</div>
</div>
</div>
<div class="section" id="fmriprep-report">
<h2>fMRIPrep Report<a class="headerlink" href="#fmriprep-report" title="Permalink to this headline">¶</a></h2>
<p>fMRIPrep outputs will live in <span class="blue">/data/bids/derivatives/fmriprep/</span></p>
<p>To have a quick look at the output of fMIRprep and make sure it ran without issues, check the <em>.html</em> output file for that subject. The <em>.html</em> file begins with a brief summary, including info about which structural images and resampling targets were used, and which functional runs were analyzed. For functional runs, make sure that slice-timing correction and susceptibility distortion correction were applied if that is what you wanted to happen!</p>
<p>Here are some general things to look for:</p>
<ul class="simple">
<li><p>The images are dynamic and portray before/afters.</p></li>
<li><p>Summary of the flags used in the actual fMRIprep analysis and all the collected confounds are summarized for each run.</p></li>
<li><p>You can get a quick sense of the quality of the signal by looking at the <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811916303871?via%3Dihub">carpetplots</a> and see the effect of motion (FD) and fluctuations of the global signal in whole-brain (brain mask), CSF and white matter over the time-course.</p></li>
<li><p>The section on the correlations among nuisance regressors can guide the decisions on removing confounds.</p></li>
<li><p>Any errors that may have occurred during preprocessing will be listed at the end of the .html report.</p></li>
</ul>
<p>For more details on fMRIPrep outputs, check <a class="reference external" href="https://fmriprep.readthedocs.io/en/stable/outputs.html#visual-reports">fMRIPrep docs</a> or our <a class="reference external" href="./03-05-fmriprepOutputs.html">Understanding your fMRIPrep outputs</a> page.</p>
<a class="reference external image-reference" href="01-05-overview.html"><img alt="return to timeline" class="align-center" src="../_images/return_to_timeline.png" style="width: 300px;" /></a>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="03-03-mriqc.html" title="Previous document">Quality control with MRIQC</a>
        </li>
        <li>
          <a href="03-05-fmriprepOutputs.html" title="Next document">Understanding your fMRIprep outputs</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<div class="footer">
  <div style="text-align: left;" id="waldo-tag-2171"></div>
  <p>&copy;2021 CC-BY-SA - <a href="website_info.html">Website Info</a></p>
</div>


 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>