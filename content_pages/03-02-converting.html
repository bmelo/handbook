
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Converting data to BIDS using HeuDiConv &#8212; The Princeton Handbook for Reproducible Neuroimaging</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="canonical" href="https://brainhack-princeton.github.io/handbook//content_pages/03-02-converting.html" />
    <link rel="shortcut icon" href="../_static/tigerBrain_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Quality control with MRIQC" href="03-03-mriqc.html" />
    <link rel="prev" title="Practice using BIDS with our sample data" href="03-01-sampleProjectWithBIDS.html" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    div.body {
      min-width: initial;
      max-width: initial;
    }
  </style>

  
  <link rel="canonical" href="https://handbook.datalad.org/content_pages/03-02-converting/"/>
  <meta property="og:url" content="https://handbook.datalad.org/content_pages/03-02-converting">
  

  <link rel="icon" type="image/png" href="https://media.readthedocs.org/images/favicon.png">

  <meta name="twitter:card" content="summary">
  <meta property="twitter:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:title" content="Converting data to BIDS using HeuDiConv &#8212; The Princeton Handbook for Reproducible Neuroimaging">
  <meta property="og:type" content="article">
  
  <meta property="og:description" content="">


  </head><body>
  <script type="text/javascript">

  $(window).scroll(function () {
    var s = $(window).scrollTop(),
          d = $(document).height(),
          c = $(window).height();
          scrollPercent = (s / (d-c)) * 100;
          var position = scrollPercent;

     $("#progressbar").attr('value', position);
  });
  </script>

  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="../index.html">
    <img class="logo" width="500" src="../_static/tigerBrain.png" title="The Princeton Handbook on Reproducible Neuroimaging"/>
  </a>
</p>

<!-- <p style="margin-left:auto; margin-right: auto;"><iframe src="https://ghbtns.com/github-btn.html?repo=book&user=datalad-handbook&type=star&count=true&size=large" allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe></p> -->

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> -->
<style>
.algolia-autocomplete{
  width: 100%;
  height: 1.5em
}
.algolia-autocomplete a{
  border-bottom: none !important;
}
#doc_search{
  width: 100%;
  height: 100%;
}
</style>

<progress id="progressbar" value="0" max="100"></progress>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Converting data to BIDS using HeuDiConv</a><ul>
<li><a class="reference internal" href="#do-this-once-setting-up-your-directory-structure-for-a-new-study">Do this once: Setting up your directory structure for a new study</a></li>
<li><a class="reference internal" href="#convert-dicoms-to-bids-formatted-nifti">Convert DICOMS to BIDS-formatted NIFTI</a><ul>
<li><a class="reference internal" href="#step-1-convert-your-dicoms-into-nifti-files-using-heudiconv"><em>Step 1: Convert your dicoms into nifti files using HeuDiConv</em></a></li>
<li><a class="reference internal" href="#step-2-get-your-data-ready-to-pass-the-bids-validator"><em>Step 2: Get your data ready to pass the bids-validator</em></a></li>
<li><a class="reference internal" href="#step-3-run-the-bids-validator"><em>Step 3: Run the BIDS validator</em></a></li>
<li><a class="reference internal" href="#step-4-deface-anatomical-images"><em>Step 4: Deface anatomical images</em></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="03-01-sampleProjectWithBIDS.html" title="previous chapter">Practice using BIDS with our sample data</a></li>
      <li>Next: <a href="03-03-mriqc.html" title="next chapter">Quality control with MRIQC</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><!-- Alabaster (krTheme++) Hacks -->
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            <div style="display:block;position:relative; margin-bottom: 1em;">
              <div style="display:block;width:100%;padding-top:12.5%;"></div>
              <div class="rpad" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
            </div>
            
  <div class="section" id="converting-data-to-bids-using-heudiconv">
<span id="converting"></span><h1>Converting data to BIDS using HeuDiConv<a class="headerlink" href="#converting-data-to-bids-using-heudiconv" title="Permalink to this headline">¶</a></h1>
<style> .blue {color:blue} </style>
<style> .red {color:red} </style><p>For a guided tutorial of everything on this page, check out the video recordings from our <a class="reference external" href="pygers_workshops/syllabus2020.html">Pygers Workshop</a>.</p>
<div class="section" id="do-this-once-setting-up-your-directory-structure-for-a-new-study">
<h2>Do this once: Setting up your directory structure for a new study<a class="headerlink" href="#do-this-once-setting-up-your-directory-structure-for-a-new-study" title="Permalink to this headline">¶</a></h2>
<p>Getting data off the scanner in a BIDS-formatted way requires that your directories are setup in a specific way. To make things simpler, we have made a template folder with the directory structure already in place. Copy the folder <span class="blue">new_study_template</span>, which can be found in <span class="blue">/jukebox/norman/pygers/handbook/new_study_template</span>, to wherever you would like your new study directory to live.</p>
<p>The specific steps to copy the folder using the terminal are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># log into spock or scotty</span>
$ ssh -XY username@spock.pni.princeton.edu
$ ssh -XY username@scotty.pni.princeton.edu

<span class="c1"># copy the study template to your own directory</span>
$ cp -r /jukebox/norman/pygers/handbook/new_study_template /jukebox/YOURLAB/USERNAME/

<span class="c1"># rename new_study_template with your study name</span>
$ <span class="nb">cd</span> /jukebox/YOURLAB/USERNAME
$ mv new_study_template <span class="o">[</span>STUDYNAME<span class="o">]</span>

<span class="c1"># if you are working with our sample data, called it sample_project:</span>
$ <span class="nb">cd</span> /jukebox/YOURLAB/USERNAME
$ mv new_study_template sample_project
<span class="c1"># from now on, replace YOURSTUDY in path examples with &#39;sample_project&#39;</span>
</pre></div>
</div>
<p>Here is the hierarchy of the folders in the <span class="blue">new_study_template</span> folder.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tree

└── new_study_template               <span class="c1"># copy this directory to setup the entire directory structure for a new project</span>
    └── code
        └── analysis                 <span class="c1"># [example] analysis code can live here</span>
        └── preprocessing            <span class="c1"># this is where heudiconv, fmriprep, mriqc scripts live</span>
        └── task                     <span class="c1"># [example] task code can live here</span>
    └── data
        └── behavioral               <span class="c1"># [example] other data (e.g. behavioral) can live at this level</span>
        └── bids                     <span class="c1"># this is where raw BIDS data will be saved by HeuDiConv</span>
            └── sub-001              <span class="c1"># these sub directories don&#39;t exist until you run HeuDiConv</span>
            └── sub-002
            └── sub-003
            └── derivatives          <span class="c1"># this is where everything &quot;derived&quot; from BIDS data will live</span>
                └── deface           <span class="c1"># defaced T1 images go here</span>
                    └── logs         <span class="c1"># slurm logs</span>
                └── fmriprep         <span class="c1"># fmriprep-preprocessed data will go here</span>
                    └── logs         <span class="c1"># slurm logs</span>
                └── freesurfer       <span class="c1"># fmriprep will also run freesurfer reconstruction and outputs go here</span>
                └── mriqc            <span class="c1"># mriqc output will go here</span>
                    └── logs         <span class="c1"># slurm logs</span>
            └── .bidsignore          <span class="c1"># similar to .gitignore, list all files/directories you don’t want to be checked by the bids-validator</span>
        └── dicom                    <span class="c1"># raw dicoms copied from the scanner go here</span>
            └── check_volumes        <span class="c1"># outputs checking that all dicoms transferred</span>
        └── work                     <span class="c1"># work files generated by fMRIprep and MRIQC</span>
</pre></div>
</div>
<p>IMPORTANT NOTES:</p>
<ul class="simple">
<li><p>You need to decide where your intermediate <em>work</em> files will live. One option is to send them to the <span class="blue">data/work</span> directory included in <span class="blue">new_study_template</span>. You can also send them to the <span class="blue">scratch</span> volume on the PNI server. This could be a good idea because intermediate work files take up a lot of space, and scratch is not backed up like the rest of the server. So you can save space on the server by not having the work files backed up. You <em>most likely</em> won’t need the work files after MRIQC and fMRIPrep have finished running for a given subject. Worst case scenario, if you lose your work files and realize you need them for some reason, you can just re-run MRIQC or fMRIPrep. In order to move forward with the scratch option, you will need to setup a directory for work files on scratch.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># navigate to scratch</span>
$ <span class="nb">cd</span> /jukebox/scratch

<span class="c1"># make yourself a directory if you don&#39;t already have one</span>
$ mkdir &lt;USERNAME&gt;

<span class="c1"># move into your personal directory and make a work directory for this project</span>
$ <span class="nb">cd</span> &lt;USERNAME&gt;
$ mkdir work/YOURSTUDY
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>After copying the template directory for your new study, you need to update the paths in <span class="blue">globals.sh</span>. Open <span class="blue">globals.sh</span> and update the following three directories:</dt><dd><ul>
<li><p>scanner_dir (see note)</p></li>
<li><p>project_dir (path to your root study directory)</p></li>
<li><p>scratch_dir (path to where you want your work files to live for this project)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">scanner_dir</span></code> is the path to the conquest directory where your file end up after transferring off the scanner.</p>
<p>If you are following these steps to practice using BIDS with our <strong>sample project</strong>, you should make sure scanner_dir is set to copy the sample dataset from our “fake” scanner directory:</p>
<p><code class="docutils literal notranslate"><span class="pre">scanner_dir=/jukebox/norman/pygers/conquest</span></code></p>
<p>Otherwise, if you are setting this up for your own study, scanner_dir should point to the directory where your raw data are sent when you transfer data off the scanner. At PNI, if you scanned on Skyra, this is:</p>
<p><code class="docutils literal notranslate"><span class="pre">scanner_dir=/jukebox/dicom/conquest/Skyra-AWP45031/YOURLAB/YEAR</span></code></p>
<p>OR if you scanned on Prisma:</p>
<p><code class="docutils literal notranslate"><span class="pre">scanner_dir=/jukebox/dicom/conquest/Prisma-MSTZ400D/YOURLAB/YEAR</span></code></p>
</div>
<ul>
<li><p>Before running fMRIprep for the first time, you will need to download a FreeSurfer license file and save it in your <span class="blue">/code/preprocessing/</span> directory. If you decide to save it somewhere else (which is totally fine!), then you will need to update the <code class="docutils literal notranslate"><span class="pre">--fs-license-file</span></code> line of <span class="blue">run_fmriprep.sh</span> with the correct license file location.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/registration.html">Get a FreeSurfer license here</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Anatomical images need to be defaced before they can be shared publicly. We recommend defacing images as you collect data and saving them in <span class="blue">/data/derivatives/deface</span>, so they are available when you need them (e.g., data visualization in notebooks that may be shared publicly). Depending on the goals of your study, it may not be a good idea to preprocess your data using defaced images (e.g., it might introduce registration problems), so that is why we have them set aside in the derivatives directory here.</p></li>
</ul>
</div>
<div class="section" id="convert-dicoms-to-bids-formatted-nifti">
<h2>Convert DICOMS to BIDS-formatted NIFTI<a class="headerlink" href="#convert-dicoms-to-bids-formatted-nifti" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-convert-your-dicoms-into-nifti-files-using-heudiconv">
<h3><em>Step 1: Convert your dicoms into nifti files using HeuDiConv</em><a class="headerlink" href="#step-1-convert-your-dicoms-into-nifti-files-using-heudiconv" title="Permalink to this headline">¶</a></h3>
<p>This step will use the following four scripts (all of which can be found in <span class="blue">/code/preprocessing</span>):</p>
<ul class="simple">
<li><p>step1_preproc.sh</p></li>
<li><p>number_of_files.py</p></li>
<li><p>run_heudiconv.py</p></li>
<li><p>deface.sh</p></li>
</ul>
<p>The script <span class="blue">step1_preproc.sh</span> will do five things for you:</p>
<ol class="arabic simple">
<li><p>copy your DICOM files from “conquest” and place them in your study directory (<span class="blue">/data/dicom/</span>)</p></li>
<li><p>count the number of volumes in each run so you can check that your data transfer was successful (the output of this step can be found in <span class="blue">/data/dicom/check_volumes</span>, and will also be printed out in your terminal window)</p></li>
<li><p>unzip the DICOMs in your study directory</p></li>
<li><p>run HeuDiConv to convert your DICOMs (.dcm) to BIDS-formatted Nifti files (.nii)</p></li>
<li><p>Deface your T1w anatomical image and set it aside in your derivatives directory (<span class="blue">/data/bids/derivatives/deface</span>)</p></li>
</ol>
<p><a class="reference external" href="https://heudiconv.readthedocs.io/en/latest/">HeuDiDonv is a flexible DICOM converter for organizing brain imaging data into structured directory layouts</a>.</p>
<p>You should run <span class="blue">step1_preproc.sh</span> for each subject and each session separately. You can run <span class="blue">step1_preproc.sh</span> as soon as your data have finished transferring off the scanner to the conquest directory (i.e., ~20 min after you finish scanning).</p>
<p>The script takes three inputs:</p>
<ul class="simple">
<li><p>subjectID</p></li>
<li><p>sessionID</p></li>
<li><p>the name of the data folder that contains your DICOM-images for that subject/session (at Princeton, this is in the “conquest” directory). You can get this information by listing the files in the conquest directory:</p>
<ul>
<li><p>from <strong>Skyra</strong>: <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">/jukebox/dicom/conquest/Skyra-AWP45031/YOURLAB/YEAR</span></code></p></li>
<li><p>from <strong>Prisma</strong>: <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">/jukebox/dicom/conquest/Prisma-MSTZ400D/YOURLAB/YEAR</span></code></p></li>
<li><p><strong>sample project</strong>: <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">/jukebox/norman/pygers/conquest</span></code></p></li>
</ul>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Add the above <code class="docutils literal notranslate"><span class="pre">ls</span></code> command as an alias in your .bashrc file to easily get this info when you need it:</p>
<p><code class="docutils literal notranslate"><span class="pre">alias</span> <span class="pre">'conquest'='ls</span> <span class="pre">/jukebox/dicom/conquest/Skyra-AWP45031/YOURLAB/YEAR'</span></code></p>
<p>Then instead of typing out the full conquest path every time you want to see the files in that directory, you can simply type <em>conquest</em> on your command line!</p>
</div>
<p>Whatever subjectID you use as your first input will correspond to how your BIDS subject folders are named (eg., inputting 999 above will result in a directory called sub-999).</p>
<p>SessionID (second input) should match how your runs were named on the scanner (e.g., input 01 for sessionID if your runs were named <span class="blue">func_ses-01_task-study_run-01</span>). <em>If your study doesn’t include multiple sessions per subject, you will need to make some modifications to these scripts to remove the session information.</em></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you need to, run <span class="blue">step1_preproc.sh</span> line by line to check that the correct paths will go into <span class="blue">run_heudiconv.py</span>. If there is a problem with your paths, check your <span class="blue">globals.sh</span> file.</p>
</div>
<dl class="simple">
<dt>We recommended running <span class="blue">step1_preproc.sh</span> in a tmux window so you don’t run into issues with losing connection to the server, etc. After ssh-ing into the server, create a new tmux window OR attach to an exisiting tmux window. After creating a new window, you can attach to that specific window/session in the future. In other words, you don’t have to create a new window every time you run <span class="blue">step1_preproc.sh</span>.</dt><dd><ul class="simple">
<li><p>Create a new tmux window: <code class="docutils literal notranslate"><span class="pre">tmux</span> <span class="pre">new</span> <span class="pre">-s</span> <span class="pre">[name]</span></code></p></li>
<li><p>Attach to an existing window: <code class="docutils literal notranslate"><span class="pre">tmux</span> <span class="pre">a</span> <span class="pre">-t</span> <span class="pre">[name]</span></code></p></li>
<li><p>NOTE: replace <code class="docutils literal notranslate"><span class="pre">[name]</span></code> with whatever you want to name your tmux window – we recommend naming it <em>step1</em>.</p></li>
<li><p><a class="reference external" href="hack_pages/tmux.html">tmux tip page</a></p></li>
<li><p><a class="reference external" href="https://tmuxcheatsheet.com/">tmux cheatsheet</a></p></li>
</ul>
</dd>
</dl>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a new tmux window</span>
$ tmux new -s step1

<span class="c1"># OR attach to an existing tmux window</span>
$ tmux a -t step1

<span class="c1"># make sure you are in your study&#39;s code/preprocessing directory</span>
$ <span class="nb">cd</span> /jukebox/YOURLAB/USERNAME/YOURSTUDY/code/preprocessing

<span class="c1"># list files available in conquest directory to get data folder name for input 3</span>
$ ls /jukebox/dicom/conquest/Skyra-AWP45031/YOURLAB/YEAR
<span class="c1"># OR</span>
$ ls /jukebox/dicom/conquest/Prisma-MSTZ400D/YOURLAB/YEAR
<span class="c1"># OR (sample project)</span>
$ ls /jukebox/norman/pygers/conquest

<span class="c1"># run the script step1_preproc.sh for subject XXX, session xx</span>
<span class="c1"># replace XXX with your subject ID</span>
<span class="c1"># replace xx with your session ID</span>
$ ./step1_preproc.sh XXX xx <span class="o">[</span>conquest folder<span class="o">]</span>

<span class="c1"># NOTE: For the sample project, use the following command:</span>
$ ./step1_preproc.sh <span class="m">001</span> <span class="m">01</span> 0219191_mystudy-0219-1114
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If HeuDiConv is failing, check that your original dicoms are only zipped one time (meaning only one .gz extension instead of .gz.gz). If your dicoms are zipped multiple times (sometimes this happens!), add another line for gunzipping again. Basically do this until your files only have the .dcm extension.</p>
</div>
</div>
<div class="section" id="step-2-get-your-data-ready-to-pass-the-bids-validator">
<h3><em>Step 2: Get your data ready to pass the bids-validator</em><a class="headerlink" href="#step-2-get-your-data-ready-to-pass-the-bids-validator" title="Permalink to this headline">¶</a></h3>
<p>This step will use the <span class="blue">step2_preproc.sh</span> script. We recommend running this step after data for all sessions for a given subject have been acquired and run through <span class="blue">step1_preproc.sh</span>.</p>
<p>This script will carry out all the “cleanup” steps that need to be taken to make sure your data are BIDS-valid and ready for MRIQC and fMRIPrep:</p>
<ol class="arabic simple">
<li><p>delete extra files (e.g., scouts, duplicate runs)</p></li>
<li><p>rename fieldmaps (if necessary)</p></li>
<li><p>add the IntendedFor field to the fieldmap .json files so that fieldmaps can be used for susceptibility distortion correction on your functional data</p></li>
</ol>
<p>The script takes one input:</p>
<ul class="simple">
<li><p>subjectID</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>This script will need to be customized for your study! Edit this script once at the beginning of your project so that all the filenames match your naming scheme, and so the fieldmaps are being applied to the correct functional runs. If you did not collect fieldmaps, then you can ignore the steps specific to fieldmaps.</p></li>
<li><p>If an individual subject deviates from your standard (e.g., has an extra set of fieldmaps or is missing functional runs), then you will need to edit <span class="blue">step2_preproc.sh</span> again to accomodate these differences.</p></li>
<li><p><strong>Sample project</strong>: The sample dataset does NOT include fieldmaps. Therefore, when you edit the <span class="blue">step2_preproc.sh</span> for the sample project, you can comment out the lines of code dealing with the fieldmaps. You should still run <span class="blue">step2_preproc.sh</span> to delete the extra (scout and dup) files.</p></li>
</ul>
</div>
<p>If you run bids-validator and get any warnings and/or errors, put any modifications you need to make to pass the validator into this script so you can easily get subjects ready for BIDS apps as you collect more subjects. <strong>Again, this script should be customized for your experiment and not just run without editing.</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the script (step2_preproc.sh), e.g. for subject XXX</span>
$ ./step2_preproc.sh XXX

<span class="c1"># NOTE: For our sample project, use the following command</span>
$ ./step2_preproc.sh <span class="m">001</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-run-the-bids-validator">
<h3><em>Step 3: Run the BIDS validator</em><a class="headerlink" href="#step-3-run-the-bids-validator" title="Permalink to this headline">¶</a></h3>
<p>Run the BIDS validator to make sure everything is setup correctly. You should check your BIDS validation as soon as possible (i.e., after collecting your first subject’s data) so that you can fix any problems if they exist!</p>
<p>Any non-BIDS formatted files should go into your <span class="blue">../bids/derivatives</span> directory which is automatically ignored by the BIDS validator; if you (deliberately) have non-BIDS formatted files outside of the derivatives folder, then you can add them to a <span class="blue">.bidsignore</span> file.</p>
<p>You can run the BIDS validator <a class="reference external" href="http://bids-standard.github.io/bids-validator/">from your browser</a>.</p>
<p>OR (recommended) you can install the bids-validator in a conda environment and run it directly on the server or locally:</p>
<p>If you have already setup a pygers conda environment following the instructions on our <a class="reference external" href="hack_pages/conda.html">conda tip page</a>, then you are good to go! The pygers conda environment already has the bids-validator package installed.</p>
<p>If you have another conda environment and you want to add the bids-validator to that conda environment, follow these steps:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda activate &lt;myenv&gt;

<span class="c1"># first, update or install nodejs</span>
$ conda install -c conda-forge <span class="nv">nodejs</span><span class="o">=</span><span class="m">11</span>
$ node -v <span class="c1">#check node version (11.14.0)</span>

<span class="c1"># install bids-validator</span>
$ npm install -g bids-validator
$ which bids-validator <span class="c1">#shows your installation location</span>
$ bids-validator -v <span class="c1">#1.5.7 as of Dec-10-2020</span>
</pre></div>
</div>
<p>In order to run the bids-validator, you need to give it a bids dataset as the input. Make sure you have your conda environment activated, and navigate to your project directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda activate &lt;myenv&gt;
$ <span class="nb">cd</span> /jukebox/YOURLAB/USERNAME/YOURSTUDY
$ bids-validator data/bids
</pre></div>
</div>
<p>Read the red “errors” and yellow “warnings”. You should try to fix the red “errors” before you continue. Re-run until the bids-validator is appeased. Note that “warnings” can be ignored for now, but you’ll probably want to fix them at some point.</p>
</div>
<div class="section" id="step-4-deface-anatomical-images">
<h3><em>Step 4: Deface anatomical images</em><a class="headerlink" href="#step-4-deface-anatomical-images" title="Permalink to this headline">¶</a></h3>
<p><strong>IMPORTANT</strong>: The defacing step is included in <span class="blue">step1_preproc.sh</span>! We are including additional instructions here in case you would like to run it separately. However, you do not need to continue with this step if you left it as is as part of <span class="blue">step1_preproc.sh</span>.</p>
<p>Eventually, if you want to share de-identified data, you will need to deface anatomical images. You do not want to use the defaced images for any further preprocessing step (unless you are certain it won’t mess up a downstream preprocessing or analysis step). So after defacing the images, we will set them aside in the <span class="blue">../data/bids/derivatives/deface</span> so they are available whenever you need them.</p>
<p>The <span class="blue">deface.sh</span> script will run <a class="reference external" href="https://github.com/poldracklab/pydeface">pydeface</a> to deface the T1w structural images and move the defaced image into your <span class="blue">../data/bids/derivatives/deface</span> directory. It takes two inputs:</p>
<ul class="simple">
<li><p>subjectID</p></li>
<li><p>sessionID</p></li>
</ul>
<p><em>Running pydeface on the cluster:</em></p>
<p>To run pydeface on the head node, we recommend using a tmux window (it takes ~9 min to deface one image).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># open a new tmux window called deface</span>
tmux new -s deface

<span class="c1"># OR  attach to a previously opened window called deface</span>
tmux a -t deface

<span class="c1"># move into your code directory</span>
<span class="nb">cd</span> /jukebox/YOURLAB/USERNAME/YOURSTUDY/code/preprocessing

<span class="c1"># call deface script</span>
./deface.sh XXX xx <span class="c1">#example is subject XXX, session xx</span>
</pre></div>
</div>
<p>You can also run pydeface using Slurm, which is especially useful if you want to run this step for multiple subjects and/or multiple sessions all at once. The script that we will call to run a job on SLURM is <span class="blue">code/preprocessing/slurm_deface.sh</span>.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Update lines in slurm_deface.sh:</dt><dd><ul>
<li><p>Line 7: array number should be equal to all the subject numbers you want to run the script on (if you enter multiple, it will run them all in parallel) e.g., array=001,002,003</p></li>
<li><p>Lines 23 -24: update if you want to get an email with the update on the code</p></li>
<li><p>Line 34: change if you want to run on a different session besides session 1</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In Slurm scripts, lines that start with <code class="docutils literal notranslate"><span class="pre">#SBATCH</span></code> are Slurm commands, not comments! All other lines that start with <code class="docutils literal notranslate"><span class="pre">#</span></code> are regular comments.</p>
</div>
<p>To submit the job:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># move into your code directory</span>
<span class="nb">cd</span> /jukebox/YOURLAB/USERNAME/YOURSTUDY/code/preprocessing

<span class="c1"># submit the job</span>
sbatch slurm_deface.sh
</pre></div>
</div>
<p>Note you don’t have to include the subjectID and sessionID inputs here because you defined this information in the <span class="blue">slurm_deface.sh</span> script itself.</p>
<a class="reference external image-reference" href="01-05-overview.html"><img alt="return to timeline" class="align-center" src="../_images/return_to_timeline.png" style="width: 300px;" /></a>
</div>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="03-01-sampleProjectWithBIDS.html" title="Previous document">Practice using BIDS with our sample data</a>
        </li>
        <li>
          <a href="03-03-mriqc.html" title="Next document">Quality control with MRIQC</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<div class="footer">
  <div style="text-align: left;" id="waldo-tag-2171"></div>
  <p>&copy;2021 CC-BY-SA - <a href="website_info.html">Website Info</a></p>
</div>


 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>