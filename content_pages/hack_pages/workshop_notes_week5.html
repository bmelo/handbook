
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pygers Workshop Notes - Week 5 (Fall 2020) &#8212; The Princeton Handbook for Reproducible Neuroimaging</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="canonical" href="https://brainhack-princeton.github.io/handbook//content_pages/hack_pages/workshop_notes_week5.html" />
    <link rel="shortcut icon" href="../../_static/tigerBrain_favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    div.body {
      min-width: initial;
      max-width: initial;
    }
  </style>

  
  <link rel="canonical" href="https://handbook.datalad.org/content_pages/hack_pages/workshop_notes_week5/"/>
  <meta property="og:url" content="https://handbook.datalad.org/content_pages/hack_pages/workshop_notes_week5">
  

  <link rel="icon" type="image/png" href="https://media.readthedocs.org/images/favicon.png">

  <meta name="twitter:card" content="summary">
  <meta property="twitter:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:title" content="Pygers Workshop Notes - Week 5 (Fall 2020) &#8212; The Princeton Handbook for Reproducible Neuroimaging">
  <meta property="og:type" content="article">
  
  <meta property="og:description" content="">


  </head><body>
  <script type="text/javascript">

  $(window).scroll(function () {
    var s = $(window).scrollTop(),
          d = $(document).height(),
          c = $(window).height();
          scrollPercent = (s / (d-c)) * 100;
          var position = scrollPercent;

     $("#progressbar").attr('value', position);
  });
  </script>

  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="../../index.html">
    <img class="logo" width="500" src="../../_static/tigerBrain.png" title="The Princeton Handbook on Reproducible Neuroimaging"/>
  </a>
</p>

<!-- <p style="margin-left:auto; margin-right: auto;"><iframe src="https://ghbtns.com/github-btn.html?repo=book&user=datalad-handbook&type=star&count=true&size=large" allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe></p> -->

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> -->
<style>
.algolia-autocomplete{
  width: 100%;
  height: 1.5em
}
.algolia-autocomplete a{
  border-bottom: none !important;
}
#doc_search{
  width: 100%;
  height: 100%;
}
</style>

<progress id="progressbar" value="0" max="100"></progress>
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Pygers Workshop Notes - Week 5 (Fall 2020)</a><ul>
<li><a class="reference internal" href="#using-the-bids-validator">Using the BIDS validator</a><ul>
<li><a class="reference internal" href="#picking-up-where-we-left-off-last-week">Picking up where we left off last week…</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preparing-to-run-mriqc-and-fmriprep">Preparing to run MRIQC and fMRIPrep</a></li>
<li><a class="reference internal" href="#using-slurm-to-submit-jobs">Using SLURM to submit jobs</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><!-- Alabaster (krTheme++) Hacks -->
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            <div style="display:block;position:relative; margin-bottom: 1em;">
              <div style="display:block;width:100%;padding-top:12.5%;"></div>
              <div class="rpad" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
            </div>
            
  <div class="section" id="pygers-workshop-notes-week-5-fall-2020">
<h1>Pygers Workshop Notes - Week 5 (Fall 2020)<a class="headerlink" href="#pygers-workshop-notes-week-5-fall-2020" title="Permalink to this headline">¶</a></h1>
<style> .blue {color:blue} </style><div class="section" id="using-the-bids-validator">
<h2>Using the BIDS validator<a class="headerlink" href="#using-the-bids-validator" title="Permalink to this headline">¶</a></h2>
<div class="section" id="picking-up-where-we-left-off-last-week">
<h3>Picking up where we left off last week…<a class="headerlink" href="#picking-up-where-we-left-off-last-week" title="Permalink to this headline">¶</a></h3>
<p>Next, open and edit <span class="blue">/code/preprocessing/step2_preproc.sh</span>. This script will delete scout and _dup scans, as well as add the <cite>IntendedFor</cite> field to the fieldmap <cite>.json</cite> files. Since we did not collect fieldmap scans for our sample dataset, we don’t need the <cite>IntendedFor</cite> field and will comment out lines 20-66. Don’t forget to git commit your changes to <span class="blue">step2_preproc.sh</span>!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> code/preprocessing/
$ git status
$ git add step2_preproc.sh
$ git commit -m <span class="s2">&quot;ignore IntendedFor addition to fieldmap json&quot;</span>

<span class="c1"># run the script with (1) input argument: subjectID</span>
$ ./step2_preproc.sh <span class="m">001</span>
$ tree <span class="c1">#no more scouts or dups!</span>

<span class="c1"># run bids-validator again</span>
$ pygers
$ bids-validator sample_study/data/bids/
</pre></div>
</div>
</div>
</div>
<div class="section" id="preparing-to-run-mriqc-and-fmriprep">
<h2>Preparing to run MRIQC and fMRIPrep<a class="headerlink" href="#preparing-to-run-mriqc-and-fmriprep" title="Permalink to this headline">¶</a></h2>
<p>The first thing we need to do is setup your <span class="blue">/scratch</span> directory to store MRIQC and fMRIPrep work files. At PNI, we are supposed to use <span class="blue">/scratch</span> to store intermediate files that are generated during analysis (or just temporary files in general). <span class="blue">/scratch</span> is not backed up!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /jukebox/scratch
<span class="c1"># if you have not already created a directory for yourself on scratch:</span>
$ mkdir &lt;name&gt;
$ <span class="nb">cd</span> &lt;name&gt; <span class="c1">#move into your scratch directory</span>
$ mkdir work/pygers <span class="c1">#this is where we will send our pygers sample dataset work files</span>
</pre></div>
</div>
<p>If you are not at PNI, then the modification you will need to make is to setup a work directory <em>outside</em> of your BIDS directory. Note, that this is different than the directory structure copied from our <span class="blue">/new_study_template</span>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ pygers
$ <span class="nb">cd</span> sample_study/data
$ mkdir work
$ <span class="nb">cd</span> bids/derivatives
$ rm -r work <span class="c1">#remove old work directory</span>
</pre></div>
</div>
<p>Open the following scripts in your text editor and make the following edits:</p>
<ul class="simple">
<li><p><span class="blue">globals.sh</span>: Add the path to your scratch work directory.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">scratch_dir</span><span class="o">=</span>/jukebox/scratch/YOURDIRECTORY/work/pygers
<span class="c1"># if you are not at PNI, this will be the path to sample_study/data/work</span>
</pre></div>
</div>
<p>For the next four scripts, there are some substantial modifications we need to make in order to use the newest versions of MRIQC and fMRIPrep. Instead of listing each individual change, I have copied each script below. You should modify your copy of each of these scripts to match.</p>
<ul class="simple">
<li><p><span class="blue">deface_template.sh</span></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /bin/bash</span>

<span class="c1"># LOAD GLOBAL VARIABLES AND MODULES ON THE CLUSTER</span>
<span class="nb">source</span> globals.sh
module load fsl/6.0.2
module load pydeface/2.0.0

<span class="nv">sid</span><span class="o">=</span><span class="nv">$1</span>

<span class="nv">subj_dir</span><span class="o">=</span>sub-<span class="nv">$sid</span>

<span class="nv">T1</span><span class="o">=</span><span class="nv">$bids_dir</span>/derivatives/fmriprep/<span class="nv">$subj_dir</span>/ses-01/anat/<span class="si">${</span><span class="nv">subj_dir</span><span class="si">}</span>_ses-01_desc-preproc_T1w.nii.gz
pydeface <span class="nv">$T1</span>

<span class="nv">T1_defaced</span><span class="o">=</span><span class="nv">$bids_dir</span>/derivatives/fmriprep/<span class="nv">$subj_dir</span>/ses-01/anat/<span class="si">${</span><span class="nv">subj_dir</span><span class="si">}</span>_ses-01_desc-preproc_T1w_defaced.nii.gz
mv <span class="nv">$T1_defaced</span> <span class="nv">$defaced_dir</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="blue">run_mriqc.sh</span></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">source</span> globals.sh

singularity run --cleanenv <span class="se">\</span>
    --bind <span class="nv">$bids_dir</span>:/bids <span class="se">\</span>
    --bind <span class="nv">$scratch_dir</span>:/scratch <span class="se">\</span>
    --bind /usr/people <span class="se">\</span>
    /jukebox/hasson/singularity/mriqc/mriqc-v0.15.1.simg <span class="se">\</span>
    --participant-label <span class="nv">$1</span> <span class="se">\</span>
    --correct-slice-timing --no-sub <span class="se">\</span>
    --nprocs <span class="m">8</span> -w /scratch <span class="se">\</span>
    /bids /bids/derivatives/mriqc participant
</pre></div>
</div>
<ul class="simple">
<li><p><span class="blue">run_mriqc_group.sh</span></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">source</span> globals.sh

singularity run --cleanenv <span class="se">\</span>
    --bind <span class="nv">$bids_dir</span>:/bids <span class="se">\</span>
    --bind <span class="nv">$scratch_dir</span>:/scratch <span class="se">\</span>
    --bind /usr/people <span class="se">\</span>
    /jukebox/hasson/singularity/mriqc/mriqc-v0.15.1.simg <span class="se">\</span>
    --correct-slice-timing --modalities T1w bold <span class="se">\</span>
    --no-sub <span class="se">\</span>
    --nprocs <span class="m">8</span> -w /scratch <span class="se">\</span>
    /bids /bids/derivatives/mriqc group
</pre></div>
</div>
<ul class="simple">
<li><p><span class="blue">run_fmriprep.sh</span></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">source</span> globals.sh

<span class="nb">export</span> <span class="nv">SINGULARITYENV_TEMPLATEFLOW_HOME</span><span class="o">=</span>/home/fmriprep/.cache/templateflow

singularity run --cleanenv <span class="se">\</span>
    --bind <span class="nv">$project_dir</span>:/project <span class="se">\</span>
    --bind <span class="nv">$scratch_dir</span>:/scratch <span class="se">\</span>
    --bind /usr/people <span class="se">\</span>
    --bind /jukebox/hasson/templateflow:/home/fmriprep/.cache/templateflow <span class="se">\</span>
    /jukebox/hasson/singularity/fmriprep/fmriprep-v20.2.0.simg <span class="se">\</span>
    --participant-label sub-<span class="nv">$1</span> <span class="se">\</span>
    --fs-license-file /project/code/preprocessing/license.txt <span class="se">\</span>
    --no-submm-recon <span class="se">\</span>
    --use-syn-sdc --bold2t1w-dof <span class="m">6</span> <span class="se">\</span>
    --nthreads <span class="m">8</span> --omp-nthreads <span class="m">8</span> <span class="se">\</span>
    --output-spaces T1w fsaverage:den-41k <span class="se">\</span>
                    MNI152NLin2009cAsym:res-native MNI152NLin2009cAsym:res-2 <span class="se">\</span>
    --write-graph --work-dir /scratch <span class="se">\</span>
    /project/data/bids /project/data/bids/derivatives participant
</pre></div>
</div>
<p>Commit your changes!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> code/preprocessing/
$ git status
$ git add globals.sh
$ git commit -m <span class="s2">&quot;add scratch_dir&quot;</span>
$ git add deface_template.sh
$ git commit -m <span class="s2">&quot;update fmriprep anat directory&quot;</span>
$ git add run_mriqc.sh
$ git add run_mriqc_group.sh
$ git commit -m <span class="s2">&quot;update MRIQC version; send work to scratch&quot;</span>
$ git add run_fmriprep.sh
$ git commit -m <span class="s2">&quot;update fmriprep version; add fieldmapless SDC; send work to scratch&quot;</span>
$ git push
</pre></div>
</div>
</div>
<div class="section" id="using-slurm-to-submit-jobs">
<h2>Using SLURM to submit jobs<a class="headerlink" href="#using-slurm-to-submit-jobs" title="Permalink to this headline">¶</a></h2>
<p>Open the following scripts in your text editor and make the following edits:</p>
<ul class="simple">
<li><p><span class="blue">slurm_mriqc.sh</span>: (Line 25) add your email address.</p></li>
<li><p><span class="blue">slurm_fmriprep.sh</span>: (Line 12) reduce requested time to 18:00:00; (Line 25) add your email address.</p></li>
</ul>
<p>Commit your changes!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git status
$ git add slurm_mriqc.sh
$ git add slurm_fmriprep.sh
$ git commit -m <span class="s2">&quot;update email address and requested time&quot;</span>
$ git push

<span class="c1"># submit SLURM jobs!</span>
$ <span class="nb">pwd</span> <span class="c1">#make sure you are in the /code/preprocessing directory</span>
$ sbatch slurm_mriqc.sh
$ sbatch slurm_fmriprep.sh
$ squeue -u &lt;netID&gt;
</pre></div>
</div>
<p>Helpful SLURM commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sbatch &lt;script.sh&gt;        <span class="c1">#submit a job</span>
$ squeue                    <span class="c1">#list all jobs running</span>
$ squeue -u &lt;netID&gt;         <span class="c1">#list your jobs</span>
$ scancel &lt;jobID&gt;           <span class="c1">#cancel a job</span>
$ scancel -u &lt;netID&gt;        <span class="c1">#cancel all your jobs</span>
$ scontrol hold &lt;jobID&gt;     <span class="c1">#hold a job from being scheduled</span>
$ scontrol release &lt;jobID&gt;  <span class="c1">#release a job to be scheduled</span>
</pre></div>
</div>
<p><a class="reference external" href="./syllabus2020.html">Return to workshop info</a></p>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<div class="footer">
  <div style="text-align: left;" id="waldo-tag-2171"></div>
  <p>&copy;2020 CC-BY-SA - <a href="website_info.html">Website Info</a></p>
</div>


 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>